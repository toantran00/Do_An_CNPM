<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Lịch sử Bán hàng & Doanh thu - Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/admin/sales-history/sales-history.css}">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div th:replace="~{admin/fragments/navbar :: navbar}"></div>

            <main class="main-content">
                <div th:replace="~{admin/fragments/header :: header}"></div>

                <div class="stats-container">
                    <!-- Admin Overview Card -->
                    <div class="admin-overview-card">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="overview-title">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Tổng quan Doanh thu Hệ thống
                                </h4>
                                <div class="overview-details">
                                    <span class="overview-info-item">
                                        <i class="fas fa-store me-1"></i>
                                        Quản lý Doanh thu Toàn hệ thống
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="system-status-badge status-active">
                                    Hệ thống Đang hoạt động
                                </div>
                                <div class="system-stats mt-2">
                                    <small>Tổng cửa hàng: <strong th:text="${salesStats.storeCount}">0</strong></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Statistics Cards -->
                    <!-- Sales Statistics Cards - 5 boxes trên 1 dòng -->
					<div class="sales-stats-cards">
					    <div class="sales-stat-card revenue">
					        <div class="stat-icon">
					            <i class="fas fa-money-bill-wave"></i>
					        </div>
					        <div class="stat-content">
					            <div class="stat-value" th:text="${#numbers.formatDecimal(salesStats.totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
					            <div class="stat-label">Tổng Doanh thu</div>
					            <small class="text-muted" th:if="${selectedStoreId != null}">Cửa hàng đã chọn</small>
					            <small class="text-muted" th:unless="${selectedStoreId != null}">Toàn hệ thống</small>
					        </div>
					    </div>
					    
					    <div class="sales-stat-card orders">
					        <div class="stat-icon">
					            <i class="fas fa-shopping-cart"></i>
					        </div>
					        <div class="stat-content">
					            <div class="stat-value" th:text="${salesStats.totalCompletedOrders}">0</div>
					            <div class="stat-label">Đơn hàng Hoàn thành</div>
					            <small class="text-muted" th:if="${selectedStoreId != null}">Cửa hàng đã chọn</small>
					            <small class="text-muted" th:unless="${selectedStoreId != null}">Toàn hệ thống</small>
					        </div>
					    </div>
					    
					    <div class="sales-stat-card cancelled">
					        <div class="stat-icon">
					            <i class="fas fa-times-circle"></i>
					        </div>
					        <div class="stat-content">
					            <div class="stat-value" th:text="${salesStats.totalCancelledOrders}">0</div>
					            <div class="stat-label">Đơn hàng Đã hủy</div>
					            <small class="text-muted" th:if="${selectedStoreId != null}">Cửa hàng đã chọn</small>
					            <small class="text-muted" th:unless="${selectedStoreId != null}">Toàn hệ thống</small>
					        </div>
					    </div>
					    
					    <div class="sales-stat-card products">
					        <div class="stat-icon">
					            <i class="fas fa-box"></i>
					        </div>
					        <div class="stat-content">
					            <div class="stat-value" th:text="${salesStats.totalProductsSold}">0</div>
					            <div class="stat-label">Sản phẩm Đã bán</div>
					            <small class="text-muted" th:if="${selectedStoreId != null}">Cửa hàng đã chọn</small>
					            <small class="text-muted" th:unless="${selectedStoreId != null}">Toàn hệ thống</small>
					        </div>
					    </div>
					    
					    <div class="sales-stat-card average">
					        <div class="stat-icon">
					            <i class="fas fa-calculator"></i>
					        </div>
					        <div class="stat-content">
					            <div class="stat-value" th:text="${#numbers.formatDecimal(salesStats.averageOrderValue, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
					            <div class="stat-label">Giá trị Đơn trung bình</div>
					            <small class="text-muted">Trung bình mỗi đơn hàng</small>
					        </div>
					    </div>
					</div>

                    <!-- Search and Filter Section -->
                    <div class="search-box">
					    <form th:action="@{/admin/sales-history}" method="get" class="row g-3" id="searchForm">
					        <div class="col-md-4">
					            <input type="text" 
					                   class="form-control search-input" 
					                   name="keyword" 
					                   th:value="${keyword}"
					                   placeholder="Tìm theo mã đơn hàng, email khách hàng..."
					                   id="searchKeyword">
					        </div>
					        <div class="col-md-3">
					            <input type="text" 
					                   class="form-control search-input" 
					                   name="productName" 
					                   th:value="${productName}"
					                   placeholder="Tìm theo tên sản phẩm..."
					                   id="productName">
					        </div>
					        <div class="col-md-3">
					            <button type="submit" class="btn btn-search w-100" id="submitSearchBtn">
					                <i class="fas fa-search me-2"></i>Tìm kiếm
					            </button>
					        </div>
					    </form>
					</div>

                    <!-- Date Filter Section -->
					<div class="filter-section">
					    <h6 class="filter-title">
					        <i class="fas fa-filter"></i>
					        Lọc theo thời gian & cửa hàng
					        <span class="filter-badge" th:text="${salesHistoryPage.totalElements}">0</span>
					    </h6>
					    
					    <form th:action="@{/admin/sales-history}" method="get" class="row g-3 align-items-end" id="filterForm">
					        <input type="hidden" name="keyword" th:value="${keyword}">
					        <input type="hidden" name="productName" th:value="${productName}">
					        
					        <div class="col-md-3">
					            <label class="form-label">Cửa hàng</label>
					            <select class="form-select" name="maCuaHang" id="storeSelect" onchange="this.form.submit()">
					                <option value="">Tất cả cửa hàng</option>
					                <option th:each="store : ${stores}" 
					                        th:value="${store.maCuaHang}"
					                        th:text="${store.tenCuaHang}"
					                        th:selected="${selectedStoreId != null and selectedStoreId == store.maCuaHang}">
					                </option>
					            </select>
					        </div>
					        
					        <div class="col-md-2">
					            <label class="form-label">Từ ngày</label>
					            <input type="date" class="form-control" name="startDate" id="startDateFilter" 
					                   th:value="${startDate}">
					        </div>
					        
					        <div class="col-md-2">
					            <label class="form-label">Đến ngày</label>
					            <input type="date" class="form-control" name="endDate" id="endDateFilter" 
					                   th:value="${endDate}">
					        </div>
					        
					        <div class="col-md-3 d-flex gap-2">
					            <button type="submit" class="btn btn-search flex-grow-1" id="applyFilterBtn">
					                <i class="fas fa-check me-2"></i>Áp dụng
					            </button>
					            
					            <button type="button" class="btn btn-clear-filters" onclick="clearAllFilters()" title="Xóa tất cả bộ lọc">
					                <i class="fas fa-times"></i>
					            </button>
					        </div>
					    </form>
					    
					    <div th:if="${(keyword != null and keyword != '') or (productName != null and productName != '') or startDate != null or endDate != null or selectedStoreId != null}" class="mt-3">
					        <div class="d-flex flex-wrap gap-2">
					            <th:block th:if="${keyword != null and keyword != ''}">
					                <span class="active-filter-badge">
					                    Tìm kiếm: <span th:text="${keyword}"></span>
					                    <a href="javascript:void(0)" onclick="clearFilter('keyword')" class="filter-remove">
					                        <i class="fas fa-times"></i>
					                    </a>
					                </span>
					            </th:block>
					            
					            <th:block th:if="${productName != null and productName != ''}">
					                <span class="active-filter-badge">
					                    Sản phẩm: <span th:text="${productName}"></span>
					                    <a href="javascript:void(0)" onclick="clearFilter('product')" class="filter-remove">
					                        <i class="fas fa-times"></i>
					                    </a>
					                </span>
					            </th:block>
					            
					            <th:block th:if="${selectedStoreId != null}">
					                <span class="active-filter-badge">
					                    Cửa hàng: 
					                    <span th:each="store : ${stores}" 
					                          th:if="${store.maCuaHang == selectedStoreId}"
					                          th:text="${store.tenCuaHang}">Cửa hàng</span>
					                    <a href="javascript:void(0)" onclick="clearFilter('store')" class="filter-remove">
					                        <i class="fas fa-times"></i>
					                    </a>
					                </span>
					            </th:block>
					            
					            <th:block th:if="${startDate != null or endDate != null}">
					                <span class="active-filter-badge">
					                    Thời gian: 
					                    <span th:if="${startDate != null and endDate != null}" 
					                          th:text="${#temporals.format(startDate, 'dd/MM/yyyy')} + ' - ' + ${#temporals.format(endDate, 'dd/MM/yyyy')}">
					                    </span>
					                    <span th:if="${startDate != null and endDate == null}" 
					                          th:text="'Từ ' + ${#temporals.format(startDate, 'dd/MM/yyyy')}">
					                    </span>
					                    <span th:if="${startDate == null and endDate != null}" 
					                          th:text="'Đến ' + ${#temporals.format(endDate, 'dd/MM/yyyy')}">
					                    </span>
					                    <a href="javascript:void(0)" onclick="clearFilter('date')" class="filter-remove">
					                        <i class="fas fa-times"></i>
					                    </a>
					                </span>
					            </th:block>
					            
					            <th:block th:if="${(keyword != null and keyword != '') or (productName != null and productName != '') or startDate != null or endDate != null or selectedStoreId != null}">
					                <a href="javascript:void(0)" onclick="clearFilter('all')" class="active-filter-badge" style="background: #e94560; color: white; cursor: pointer;">
					                    <i class="fas fa-trash me-1"></i>Xóa tất cả
					                </a>
					            </th:block>
					        </div>
					    </div>
					</div>

                    <!-- Table Section -->
                    <div class="table-container">
                        <div class="table-header-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Lịch sử Bán hàng Toàn hệ thống
                                    <span class="order-count-badge" th:text="${salesHistoryPage.totalElements}">0</span>
                                </h4>	
                                <div class="export-button-group">
                                    <button type="button" class="btn btn-excel-export" id="exportTotalBtn">
								        <i class="fas fa-file-excel me-2"></i>Xuất Excel Tổng
								    </button>
                                </div>
                            </div>
                            
                            <div id="selectionControls" class="selection-controls" style="display: none;">
                                <span class="selected-count">
                                    Đã chọn: <strong id="selectedCount">0</strong> sản phẩm
                                </span>
                                <button type="button" class="btn btn-clear-selection btn-sm me-2" onclick="clearSelection()">
                                    <i class="fas fa-times me-1"></i>Bỏ chọn
                                </button>
                                
                                <button type="button" class="btn btn-excel-export btn-sm" id="exportSelectedBtn">
                                    <i class="fas fa-file-excel me-1"></i>Xuất Excel đã chọn
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table sales-history-table">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <div class="form-check d-flex justify-content-center">
                                                <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                            </div>
                                        </th>
                                        <th width="80">Mã ĐH</th>
                                        <th>Cửa hàng</th>
                                        <th>Khách hàng</th>
                                        <th width="200">Sản phẩm</th>
                                        <th width="100" class="text-center">Số lượng</th>
                                        <th width="120" class="text-center">Đơn giá</th>
                                        <th width="120" class="text-center">Thành tiền</th>
                                        <th width="120" class="text-center">Ngày thanh toán</th>
                                        <th width="140" class="text-center">Phương thức TT</th>
                                        <th width="140" class="text-center">Trạng thái TT</th>
                                        <th width="140" class="text-center">Người giao hàng</th>
                                        <th width="100" class="text-center">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="orderDetail : ${salesHistoryPage.content}">
                                        <td>
                                            <div class="form-check d-flex justify-content-center">
                                                <input class="form-check-input order-checkbox" 
                                                       type="checkbox" 
                                                       th:value="${orderDetail.datHang.maDatHang}"
                                                       th:attr="data-quantity=${orderDetail.soLuong}">
                                            </div>
                                        </td>	
                                        <td class="text-center">
                                            <strong th:text="${orderDetail.datHang.maDatHang}">1</strong>
                                        </td>
                                        <td>
                                            <div class="store-info">
                                                <strong th:text="${orderDetail.sanPham.cuaHang.tenCuaHang}">Cửa hàng</strong>
                                                <small class="text-muted d-block" th:text="${orderDetail.sanPham.cuaHang.email}">email@store.com</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="customer-info">
                                                <strong th:text="${orderDetail.datHang.nguoiDung.tenNguoiDung != null ? orderDetail.datHang.nguoiDung.tenNguoiDung : orderDetail.datHang.nguoiDung.email}">Khách hàng</strong>
                                                <small class="text-muted d-block" th:text="${orderDetail.datHang.nguoiDung.email}">email@example.com</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="product-info">
                                                <div class="product-image-small">
                                                    <img th:src="${orderDetail.sanPham.hinhAnh != null ? '/uploads/products/' + orderDetail.sanPham.hinhAnh : '/images/default-product.jpg'}" 
                                                         alt="Product Image">
                                                </div>
                                                <div class="product-details">
                                                    <h6 class="product-name" th:text="${orderDetail.sanPham.tenSanPham}">Tên sản phẩm</h6>
                                                    <small class="text-muted" th:text="${orderDetail.sanPham.loaiSanPham}">Loại sản phẩm</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="quantity-badge" th:text="${orderDetail.soLuong}">1</span>
                                        </td>
                                        <td class="text-center price-cell">
                                            <span th:text="${#numbers.formatDecimal(orderDetail.giaBan, 0, 'COMMA', 0, 'POINT')} + ' ₫'">100,000 ₫</span>
                                        </td>
                                        <td class="text-center total-cell">
                                            <strong th:text="${#numbers.formatDecimal(orderDetail.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' ₫'">100,000 ₫</strong>
                                        </td>
                                        <td class="text-center">
    <span class="date-display" 
          th:text="${orderDetail.datHang.thanhToans != null and !orderDetail.datHang.thanhToans.isEmpty() and orderDetail.datHang.thanhToans[0].ngayThanhToan != null ? 
          #dates.format(orderDetail.datHang.thanhToans[0].ngayThanhToan, 'dd/MM/yyyy HH:mm:ss') : 
          'Chưa thanh toán'}">
          Chưa thanh toán
    </span>
</td>
                                        <td class="text-center">
                                            <span class="payment-method-badge" 
                                                  th:text="${orderDetail.datHang.thanhToans != null and !orderDetail.datHang.thanhToans.isEmpty() ? orderDetail.datHang.thanhToans[0].phuongThuc : 'N/A'}">
                                                N/A
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span th:if="${orderDetail.datHang.thanhToans != null and !orderDetail.datHang.thanhToans.isEmpty()}" 
                                                  th:class="${(orderDetail.datHang.thanhToans[0].trangThai == 'completed' or orderDetail.datHang.thanhToans[0].trangThai == 'Hoàn thành') ? 
                                                  'status-badge payment-completed' : 
                                                  (orderDetail.datHang.thanhToans[0].trangThai == 'Pending' ? 
                                                  'status-badge payment-pending' : 
                                                  'status-badge payment-failed')}"
                                                  th:text="${orderDetail.datHang.thanhToans[0].trangThai == 'completed' or orderDetail.datHang.thanhToans[0].trangThai == 'Hoàn thành' ? 
                                                           'Hoàn thành' : 
                                                           (orderDetail.datHang.thanhToans[0].trangThai == 'Pending' ? 
                                                           'Đang xử lý' : 
                                                           'Thất bại')}">
                                                Trạng thái thanh toán
                                            </span>
                                            <span th:if="${orderDetail.datHang.thanhToans == null or orderDetail.datHang.thanhToans.isEmpty()}" 
                                                  class="status-badge payment-pending">
                                                Chưa thanh toán
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="shipper-badge" 
                                                  th:if="${orderDetail.datHang.vanChuyens != null and !orderDetail.datHang.vanChuyens.isEmpty()}"
                                                  th:text="${orderDetail.datHang.vanChuyens[0].nguoiDung.tenNguoiDung}">
                                                Người giao hàng
                                            </span>
                                        </td>
                                        <td class="text-center">
										    <!-- Hiển thị trạng thái đơn hàng với màu sắc khác nhau -->
										    <span th:if="${orderDetail.datHang.trangThai == 'Hoàn thành'}"
										          class="status-badge order-completed">
										        <i class="fas fa-check-double me-1"></i>
										        Hoàn thành
										    </span>
										    <span th:if="${orderDetail.datHang.trangThai == 'Hủy'}"
										          class="status-badge order-cancelled">
										        <i class="fas fa-times-circle me-1"></i>
										        Đã hủy
										    </span>
										</td>
                                    </tr>
                                    <tr th:if="${salesHistoryPage.content.empty}">
                                        <td colspan="13">
                                            <div class="empty-state">
                                                <i class="fas fa-chart-line"></i>
                                                <p>Chưa có dữ liệu bán hàng</p>
                                                <small class="text-muted">Các đơn hàng đã hoàn thành sẽ hiển thị tại đây</small>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
						<div th:if="${salesHistoryPage.totalPages > 1}" class="mt-4">
						    <nav aria-label="Page navigation">
						        <ul class="pagination justify-content-center">
						            <!-- Previous Page -->
						            <li class="page-item" th:classappend="${salesHistoryPage.first} ? 'disabled' : ''">
						                <a class="page-link" 
						                   th:href="@{/admin/sales-history(page=${salesHistoryPage.number - 1}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate}, productName=${productName}, maCuaHang=${selectedStoreId})}"
						                   th:if="${!salesHistoryPage.first}">
						                    <i class="fas fa-chevron-left"></i>
						                </a>
						                <span class="page-link" th:if="${salesHistoryPage.first}">
						                    <i class="fas fa-chevron-left"></i>
						                </span>
						            </li>
						            
						            <!-- Page Numbers -->
						            <li class="page-item" 
						                th:each="i : ${#numbers.sequence(0, salesHistoryPage.totalPages - 1)}"
						                th:classappend="${i == salesHistoryPage.number} ? 'active' : ''">
						                <a class="page-link" 
						                   th:href="@{/admin/sales-history(page=${i}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate}, productName=${productName}, maCuaHang=${selectedStoreId})}"
						                   th:text="${i + 1}">1</a>
						            </li>
						            
						            <!-- Next Page -->
						            <li class="page-item" th:classappend="${salesHistoryPage.last} ? 'disabled' : ''">
						                <a class="page-link" 
						                   th:href="@{/admin/sales-history(page=${salesHistoryPage.number + 1}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate}, productName=${productName}, maCuaHang=${selectedStoreId})}"
						                   th:if="${!salesHistoryPage.last}">
						                    <i class="fas fa-chevron-right"></i>
						                </a>
						                <span class="page-link" th:if="${salesHistoryPage.last}">
						                    <i class="fas fa-chevron-right"></i>
						                </span>
						            </li>
						        </ul>
						    </nav>
						</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin/dashboard.js}"></script>
    <script th:src="@{/js/admin/sales-history/sales-history.js}"></script>
</body>
</html>